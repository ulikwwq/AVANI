@page "/goal/create"
@using AVANI.Client.Models
@inject AVANI.Client.Services.UserService UserService
@inject AVANI.Client.Services.GoalService GoalService
@inject NavigationManager Navigation

<div class="goal-create-page">
    <h2>–ù–æ–≤–∞—è —Ü–µ–ª—å</h2>

    <div class="card form-card">
        <label class="field-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏</label>
        <input class="text-input" @bind="Title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Ö–æ—á—É –≤–µ–ª–æ—Å–∏–ø–µ–¥" />

        <div class="actions">
            <button class="btn-primary" @onclick="CreateGoalAsync" disabled="@IsCreating">–°–æ–∑–¥–∞—Ç—å</button>
            <button class="btn-secondary" @onclick="() => Navigation.NavigateTo('/child')">–û—Ç–º–µ–Ω–∞</button>
        </div>

        @if (!string.IsNullOrEmpty(StatusMessage))
        {
            <div class="status">@StatusMessage</div>
        }
    </div>
</div>

@code {
    private string Title { get; set; } = string.Empty;
    private bool IsCreating = false;
    private string StatusMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var user = await UserService.GetCurrentUser();
        if (user is null || !UserService.IsChild())
        {
            Navigation.NavigateTo("/login");
            return;
        }
    }

    private async Task CreateGoalAsync()
    {
        StatusMessage = string.Empty;
        if (string.IsNullOrWhiteSpace(Title))
        {
            StatusMessage = "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏.";
            return;
        }

        IsCreating = true;
        try
        {
            // Calculate price using GoalService heuristic AI
            var price = await GoalService.CalculateGoalPrice(Title);

            var goal = new GoalModel
            {
                GoalId = Guid.NewGuid().ToString(),
                Title = Title.Trim(),
                PriceCoins = price,
                Status = "Active",
                CreatedAt = DateTime.UtcNow
            };

            // Persist in GoalService and attach to current user
            await GoalService.CreateGoalAsync(goal);

            var user = await UserService.GetCurrentUser();
            if (user != null)
            {
                user.Goals.Add(goal);
                await UserService.SetCurrentUser(user);
            }

            // Navigate back to child dashboard (parent will confirm via DashboardParent)
            Navigation.NavigateTo("/child");
        }
        catch (Exception ex)
        {
            StatusMessage = "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ü–µ–ª–∏: " + ex.Message;
        }
        finally
        {
            IsCreating = false;
        }
    }
}

<style>
.goal-create-page { max-width:720px; margin:0 auto; padding:16px; }
.form-card { background:linear-gradient(180deg,#fff,#fbf7ff); padding:18px; border-radius:12px; border:1px solid #eee; }
.field-label { display:block; font-weight:700; margin-bottom:6px; color:#374151; }
.text-input { width:100%; padding:12px 14px; border-radius:8px; border:1px solid #e6e6e6; margin-bottom:12px; font-size:1rem; }
.actions { display:flex; gap:10px; }
.btn-primary { background:linear-gradient(90deg,#10b981,#059669); color:white; padding:10px 16px; border-radius:8px; border:none; font-weight:700; }
.btn-secondary { background:transparent; padding:10px 16px; border-radius:8px; border:2px solid #d1d5db; }
.status { margin-top:10px; color:#6b7280; }
</style>@page "/create-goal"
@page "/goal/create"
@using AVANI.Client.Models
@inject AVANI.Client.Services.UserService UserService
@inject AVANI.Client.Services.GoalService GoalService
@inject NavigationManager Navigation

<div class="goal-create-container">
    <h2>–ü–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Ü–µ–ª—å</h2>

    <div class="card form-card">
        <form @onsubmit="CreateGoalAsync">
            <div class="form-group">
                <label for="title">–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏</label>
                <input 
                    id="title" 
                    type="text" 
                    @bind="GoalTitle" 
                    placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–æ—á–∏—Ç–∞—Ç—å –∫–Ω–∏–≥—É, –í—ã—É—á–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É —É–º–Ω–æ–∂–µ–Ω–∏—è..."
                    maxlength="100"
                    required 
                />
                <span class="char-count">@GoalTitle.Length / 100</span>
            </div>

            <div class="form-group">
                <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <textarea 
                    id="description" 
                    @bind="GoalDescription" 
                    placeholder="–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ —Å–≤–æ–µ–π —Ü–µ–ª–∏..."
                    maxlength="200"
                    rows="4"
                />
                <span class="char-count">@GoalDescription.Length / 200</span>
            </div>

            <!-- AI-Calculated Cost -->
            <div class="form-group">
                <label>–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</label>
                <div class="cost-box">
                    @if (IsCalculating)
                    {
                        <div style="text-align:center; padding:16px; color:#666">
                            <span>‚è≥ –†–∞—Å—Å—á–∏—Ç—ã–≤–∞—é —Å—Ç–æ–∏–º–æ—Å—Ç—å...</span>
                        </div>
                    }
                    else if (CalculatedPrice > 0)
                    {
                        <div style="text-align:center">
                            <div style="font-size:2em; font-weight:bold; color:#fbbf24">
                                ü™ô @CalculatedPrice –º–æ–Ω–µ—Ç
                            </div>
                            <div style="font-size:0.9em; color:#666; margin-top:8px">
                                –†–æ–¥–∏—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç —ç—Ç—É —Ü–µ–ª—å –ø–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è
                            </div>
                        </div>
                    }
                    else
                    {
                        <div style="text-align:center; padding:16px; color:#999">
                            –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å
                        </div>
                    }
                </div>
            </div>

            <!-- Difficulty Level (for better AI estimation) -->
            <div class="form-group">
                <label for="difficulty">–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
                <select id="difficulty" @bind="SelectedDifficulty">
                    <option value="easy">–õ–µ–≥–∫–æ</option>
                    <option value="medium">–°—Ä–µ–¥–Ω–µ</option>
                    <option value="hard">–°–ª–æ–∂–Ω–æ</option>
                </select>
            </div>

            <!-- Error & Success Messages -->
            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="message error-message">
                    ‚ö† @ErrorMessage
                </div>
            }

            @if (!string.IsNullOrEmpty(SuccessMessage))
            {
                <div class="message success-message">
                    ‚úì @SuccessMessage
                </div>
            }

            <!-- Action Buttons -->
            <div class="button-group">
                <button type="submit" class="btn-primary" disabled="@(IsSubmitting || CalculatedPrice == 0)">
                    @(IsSubmitting ? "–°–æ–∑–¥–∞—é..." : "‚úì –°–æ–∑–¥–∞—Ç—å —Ü–µ–ª—å")
                </button>
                <button type="button" class="btn-secondary" @onclick="GoBack">
                    ‚Üê –ù–∞–∑–∞–¥
                </button>
            </div>
        </form>
    </div>

    <!-- Info Section -->
    <div class="card info-card">
        <h4>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</h4>
        <ul style="margin:0; padding-left:20px">
            <li>–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–≤–æ–µ–π —Ü–µ–ª–∏</li>
            <li>–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ –º–æ–Ω–µ—Ç–∞—Ö</li>
            <li>–û—Ç–ø—Ä–∞–≤—å —Ü–µ–ª—å –Ω–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ —Ä–æ–¥–∏—Ç–µ–ª—é</li>
            <li>–ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ç—ã —Å–º–æ–∂–µ—à—å –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É –Ω–∞–¥ —Ü–µ–ª—å—é!</li>
        </ul>
    </div>
</div>

@code {
    private string GoalTitle = string.Empty;
    private string GoalDescription = string.Empty;
    private string SelectedDifficulty = "medium";
    private int CalculatedPrice = 0;
    private bool IsCalculating = false;
    private bool IsSubmitting = false;
    private string ErrorMessage = string.Empty;
    private string SuccessMessage = string.Empty;

    private UserModel? CurrentUser;

    protected override async Task OnInitializedAsync()
    {
        CurrentUser = await UserService.GetCurrentUser();
        if (CurrentUser is null || !UserService.IsChild())
        {
            Navigation.NavigateTo("/login");
            return;
        }
    }

    private async Task CreateGoalAsync()
    {
        ErrorMessage = string.Empty;
        SuccessMessage = string.Empty;
        IsSubmitting = true;

        if (string.IsNullOrWhiteSpace(GoalTitle))
        {
            ErrorMessage = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏.";
            IsSubmitting = false;
            return;
        }

        if (CalculatedPrice <= 0)
        {
            ErrorMessage = "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
            IsSubmitting = false;
            return;
        }

        try
        {
            var newGoal = new GoalModel
            {
                GoalId = Guid.NewGuid().ToString(),
                Title = GoalTitle.Trim(),
                PriceCoins = CalculatedPrice,
                Status = "Active", // Pending confirmation by parent
                CreatedAt = DateTime.UtcNow
            };

            // Save goal to service
            await GoalService.CreateGoalAsync(newGoal);

            SuccessMessage = $"‚úì –¶–µ–ª—å '{newGoal.Title}' —Å–æ–∑–¥–∞–Ω–∞! –û–∂–∏–¥–∞–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è —Ä–æ–¥–∏—Ç–µ–ª—è.";

            // Clear form and redirect after delay
            await Task.Delay(1500);
            Navigation.NavigateTo("/child");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"–û—à–∏–±–∫–∞: {ex.Message}";
        }
        finally
        {
            IsSubmitting = false;
        }
    }

    private async Task OnTitleChanged(ChangeEventArgs e)
    {
        GoalTitle = e.Value?.ToString() ?? string.Empty;
        
        // Trigger AI cost calculation when title changes
        if (!string.IsNullOrWhiteSpace(GoalTitle) && GoalTitle.Length > 3)
        {
            await CalculateCostAsync();
        }
        else
        {
            CalculatedPrice = 0;
        }
    }

    private async Task CalculateCostAsync()
    {
        IsCalculating = true;

        try
        {
            // Simple AI logic: calculate price based on title length, difficulty, and keywords
            CalculatedPrice = CalculateGoalPrice(GoalTitle, SelectedDifficulty);

            // Simulate API delay
            await Task.Delay(300);
        }
        catch
        {
            CalculatedPrice = 0;
        }
        finally
        {
            IsCalculating = false;
        }
    }

    private int CalculateGoalPrice(string title, string difficulty)
    {
        // Base price: 10 coins
        int basePrice = 10;

        // Adjust by title length (more words = higher complexity)
        int words = title.Split(' ', StringSplitOptions.RemoveEmptyEntries).Length;
        int lengthBonus = Math.Min(words * 5, 30);

        // Difficulty multiplier
        float difficultyMultiplier = difficulty switch
        {
            "easy" => 0.8f,
            "hard" => 1.5f,
            _ => 1f
        };

        // Keyword detection (examples)
        float keywordMultiplier = 1f;
        string lowerTitle = title.ToLower();
        if (lowerTitle.Contains("–≤—ã—É—á–∏—Ç—å") || lowerTitle.Contains("–Ω–∞—É—á–∏—Ç—å—Å—è"))
            keywordMultiplier = 1.3f;
        if (lowerTitle.Contains("–ø—Ä–æ–±–µ–∂–∞—Ç—å") || lowerTitle.Contains("—Å–ø–æ—Ä—Ç"))
            keywordMultiplier = 1.2f;
        if (lowerTitle.Contains("–ø—Ä–æ—á–∏—Ç–∞—Ç—å"))
            keywordMultiplier = 1.1f;

        int finalPrice = (int)((basePrice + lengthBonus) * difficultyMultiplier * keywordMultiplier);
        return Math.Max(5, Math.Min(finalPrice, 100)); // Clamp between 5 and 100
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/child");
    }

    protected override async Task OnParametersSetAsync()
    {
        // Recalculate if title or difficulty changes
        if (!string.IsNullOrWhiteSpace(GoalTitle))
        {
            await CalculateCostAsync();
        }
    }
}

<style>
.goal-create-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 16px;
}

.form-card {
    padding: 24px;
    margin-bottom: 16px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
    color: #333;
}

.form-group input,
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 10px;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    font-family: inherit;
    font-size: 1em;
    transition: border-color 0.2s;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    outline: none;
    border-color: #5b5ef5;
    box-shadow: 0 0 0 3px rgba(91, 94, 245, 0.1);
}

.char-count {
    display: block;
    font-size: 0.85em;
    color: #999;
    margin-top: 4px;
}

.cost-box {
    background: #fefce8;
    border: 2px solid #fcd34d;
    border-radius: 8px;
    padding: 16px;
    text-align: center;
    min-height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.button-group {
    display: flex;
    gap: 8px;
    margin-top: 24px;
}

.btn-primary {
    flex: 1;
    padding: 12px 16px;
    background: linear-gradient(135deg, #5b5ef5, #4646d0);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 1em;
    cursor: pointer;
    transition: transform 0.2s;
}

.btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
}

.btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-secondary {
    flex: 1;
    padding: 12px 16px;
    background: #e5e7eb;
    color: #333;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
}

.btn-secondary:hover {
    background: #d1d5db;
}

.message {
    padding: 12px 16px;
    border-radius: 6px;
    margin-bottom: 12px;
    font-weight: 500;
}

.error-message {
    background: #fee2e2;
    border-left: 4px solid #ef4444;
    color: #991b1b;
}

.success-message {
    background: #dcfce7;
    border-left: 4px solid #10b981;
    color: #15803d;
}

.info-card {
    background: #f0f9ff;
    border: 2px solid #bfdbfe;
    padding: 16px;
}

.info-card h4 {
    margin-top: 0;
    color: #0c4a6e;
}

.info-card ul {
    color: #075985;
    line-height: 1.8;
}

@media (max-width: 640px) {
    .goal-create-container {
        padding: 8px;
    }

    .form-card {
        padding: 16px;
    }

    .button-group {
        flex-direction: column;
    }
}
</style>