@page "/compare"
@page "/shop/compare"
@using AVANI.Client.Models
@inject AVANI.Client.Services.UserService UserService
@inject NavigationManager Navigation

<div class="shop-compare-container">
    <h2>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ–Ω</h2>

    <!-- AI Tip Section -->
    <div class="card ai-tip-section">
        <div style="display:flex; gap:12px; align-items:start">
            <span style="font-size:1.8em">üí°</span>
            <div>
                <h4 style="margin:0 0 6px 0">–°–æ–≤–µ—Ç –æ—Ç AI</h4>
                <p style="margin:0; color:#666; line-height:1.6">
                    "–°—Ä–∞–≤–Ω–∏ —Ü–µ–Ω—ã –ø–µ—Ä–µ–¥ –ø–æ–∫—É–ø–∫–æ–π, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∏–º–ø—É–ª—å—Å–∏–≤–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π. 
                    –õ—É—á—à–µ –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å –Ω–µ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –∞–Ω–∞–ª–∏–∑, —á–µ–º –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å –≤—Å–µ —Å–≤–æ–∏ –º–æ–Ω–µ—Ç—ã –Ω–∞ –Ω–µ–Ω—É–∂–Ω—ã–µ –≤–µ—â–∏! ü§ì"
                </p>
            </div>
        </div>
    </div>

    <!-- Current Balance -->
    <div class="card balance-card">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <div>
                <div style="font-size:0.9em; color:#666">–¢–≤–æ–π –±–∞–ª–∞–Ω—Å</div>
                <div style="font-size:1.8em; font-weight:bold; color:#fbbf24">
                    ü™ô @CurrentBalance
                </div>
            </div>
            <div style="text-align:right; font-size:0.9em; color:#999">
                –ó–∞—Ä–∞–±–æ—Ç–∞–ª –º–æ–Ω–µ—Ç:
                <div style="font-weight:bold; color:#333; margin-top:4px">
                    @(CurrentUser?.Coins ?? 0) –∏–∑ 1000
                </div>
            </div>
        </div>
    </div>

    <!-- Shop Items Grid -->
    <div class="shop-grid">
        @if (ShopItems == null || !ShopItems.Any())
        {
            <div class="card" style="grid-column:1/-1; text-align:center; padding:40px">
                <p style="font-size:2em; margin:0">üõí</p>
                <p style="color:#999">–ú–∞–≥–∞–∑–∏–Ω –ø–æ–∫–∞ –ø—É—Å—Ç. –°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è —Ç–æ–≤–∞—Ä—ã!</p>
            </div>
        }
        else
        {
            @foreach (var item in ShopItems)
            {
                <div class="shop-item-card">
                    <div class="item-header">
                        <div class="item-icon">@item.IconUrl</div>
                        <h4 style="margin:0">@item.Name</h4>
                    </div>

                    <p class="item-description">@item.Description</p>

                    <div class="price-section">
                        <div class="price-box real-price">
                            <div class="price-label">–†–µ–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞</div>
                            <div class="price-value">@item.Price —Ä.</div>
                        </div>
                        <div class="price-box coin-price">
                            <div class="price-label">–¶–µ–Ω–∞ –≤ –º–æ–Ω–µ—Ç–∞—Ö</div>
                            <div class="price-value">ü™ô @CalculateMonetaryValue(item.Price)</div>
                        </div>
                    </div>

                    <div class="comparison-info">
                        <span class="value-ratio">
                            @GetValueRatio(item.Price) —Ä./–º–æ–Ω–µ—Ç–∞
                        </span>
                    </div>

                    <button 
                        class="btn-buy" 
                        disabled="@(CurrentBalance < CalculateMonetaryValue(item.Price))"
                        @onclick="() => BuyItem(item)">
                        @(CurrentBalance < CalculateMonetaryValue(item.Price) ? "‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç" : "üõí –ö—É–ø–∏—Ç—å")
                    </button>
                </div>
            }
        }
    </div>

    <!-- Back Button -->
    <div style="text-align:center; margin-top:24px">
        <button class="btn-back" @onclick="GoBack">
            ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ø–∞–Ω–µ–ª—å
        </button>
    </div>

    @if (!string.IsNullOrEmpty(Message))
    {
        <div class="card" style="margin-top:16px; background:#f0f9ff; border-left:4px solid #3b82f6; color:#1e40af; padding:12px 16px">
            @Message
        </div>
    }
</div>

@code {
    private UserModel? CurrentUser;
    private int CurrentBalance = 0;
    private List<ShopItemModel> ShopItems = new();
    private string Message = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        CurrentUser = await UserService.GetCurrentUser();
        if (CurrentUser is null)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        CurrentBalance = CurrentUser.Coins;

        // Initialize sample shop items
        ShopItems = new List<ShopItemModel>
        {
            new ShopItemModel
            {
                Id = 1,
                Name = "–ö–∏–Ω–¥–µ—Ä –°—é—Ä–ø—Ä–∏–∑",
                Price = 120,
                IconUrl = "ü•ö",
                Description = "–ö–∏–Ω–µ—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Å–æ–∫ —Å –∏–≥—Ä—É—à–∫–æ–π –≤–Ω—É—Ç—Ä–∏"
            },
            new ShopItemModel
            {
                Id = 2,
                Name = "–ù–∞–∫–ª–µ–π–∫–∏ '–ñ–∏–≤–æ—Ç–Ω—ã–µ'",
                Price = 50,
                IconUrl = "ü¶Å",
                Description = "–ù–∞–±–æ—Ä –∏–∑ 50 —è—Ä–∫–∏—Ö –Ω–∞–∫–ª–µ–µ–∫"
            },
            new ShopItemModel
            {
                Id = 3,
                Name = "–ö–∞—Ä–∞–Ω–¥–∞—à–∏ —Ü–≤–µ—Ç–Ω—ã–µ",
                Price = 200,
                IconUrl = "üñç",
                Description = "–ù–∞–±–æ—Ä –∏–∑ 24 –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–∞—Ä–∞–Ω–¥–∞—à–µ–π"
            },
            new ShopItemModel
            {
                Id = 4,
                Name = "–†–µ–∑–∏–Ω–∫–∞ '–§—Ä—É–∫—Ç—ã'",
                Price = 40,
                IconUrl = "üçì",
                Description = "–ó–∞–±–∞–≤–Ω–∞—è —Ä–µ–∑–∏–Ω–∫–∞ –≤ —Ñ–æ—Ä–º–µ —Ñ—Ä—É–∫—Ç–∞"
            },
            new ShopItemModel
            {
                Id = 5,
                Name = "–ü—Ä—ã–≥–∞—é—â–∏–π –º—è—á–∏–∫",
                Price = 150,
                IconUrl = "‚öΩ",
                Description = "–°–≤–µ—Ç—è—â–∏–π—Å—è –º—è—á–∏–∫ —Å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º–∏ –æ—Ç—Å–∫–æ–∫–∞–º–∏"
            },
            new ShopItemModel
            {
                Id = 6,
                Name = "–ë–ª–æ–∫–Ω–æ—Ç —Å –Ω–∞–∫–ª–µ–π–∫–∞–º–∏",
                Price = 180,
                IconUrl = "üìì",
                Description = "–ö—Ä–∞—Å–∏–≤—ã–π –±–ª–æ–∫–Ω–æ—Ç —Å –ª–∏—Å—Ç–æ–º –Ω–∞–∫–ª–µ–µ–∫"
            }
        };
    }

    private int CalculateMonetaryValue(int rubles)
    {
        // Simple conversion: 1 coin = 10 rubles (configurable)
        // Round up to ensure fairness
        return (int)Math.Ceiling(rubles / 10.0);
    }

    private string GetValueRatio(int rubles)
    {
        // How many rubles per coin
        return ((double)rubles / CalculateMonetaryValue(rubles)).ToString("F1");
    }

    private void BuyItem(ShopItemModel item)
    {
        int cost = CalculateMonetaryValue(item.Price);

        if (CurrentBalance < cost)
        {
            Message = $"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç –¥–ª—è –ø–æ–∫—É–ø–∫–∏ '{item.Name}'. –ù—É–∂–Ω–æ {cost}, –∞ —É —Ç–µ–±—è {CurrentBalance}.";
            return;
        }

        CurrentBalance -= cost;
        CurrentUser!.Coins = CurrentBalance;

        Message = $"‚úì –ü–æ–∑–¥—Ä–∞–≤–ª—è—é! –¢—ã –∫—É–ø–∏–ª '{item.Name}' –∑–∞ {cost} –º–æ–Ω–µ—Ç! üéâ";

        // Could persist to UserService/Firebase here if needed
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/child");
    }
}

<style>
.shop-compare-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 16px;
}

.ai-tip-section {
    background: linear-gradient(135deg, #dbeafe, #bfdbfe);
    border: 2px solid #7dd3fc;
    padding: 16px;
    margin-bottom: 20px;
    border-radius: 8px;
}

.ai-tip-section h4 {
    color: #0369a1;
}

.ai-tip-section p {
    color: #075985;
}

.balance-card {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    border: 2px solid #fcd34d;
    padding: 16px;
    margin-bottom: 24px;
}

.shop-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.shop-item-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 16px;
    transition: transform 0.2s, box-shadow 0.2s;
}

.shop-item-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
}

.item-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}

.item-icon {
    font-size: 2.5em;
    line-height: 1;
}

.shop-item-card h4 {
    margin: 0;
    color: #1f2937;
}

.item-description {
    font-size: 0.9em;
    color: #666;
    margin: 8px 0;
    line-height: 1.4;
}

.price-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 12px;
}

.price-box {
    padding: 10px;
    border-radius: 6px;
    text-align: center;
}

.real-price {
    background: #f3f4f6;
    border: 1px solid #d1d5db;
}

.coin-price {
    background: #fef3c7;
    border: 1px solid #fcd34d;
}

.price-label {
    font-size: 0.8em;
    color: #666;
    margin-bottom: 4px;
}

.price-value {
    font-size: 1.3em;
    font-weight: bold;
    color: #1f2937;
}

.coin-price .price-value {
    color: #d97706;
}

.comparison-info {
    text-align: center;
    padding: 8px;
    background: #f9fafb;
    border-radius: 4px;
    margin-bottom: 12px;
    font-size: 0.85em;
}

.value-ratio {
    color: #666;
    font-weight: 500;
}

.btn-buy {
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
}

.btn-buy:hover:not(:disabled) {
    background: linear-gradient(135deg, #2563eb, #1e40af);
}

.btn-buy:disabled {
    background: #d1d5db;
    color: #999;
    cursor: not-allowed;
}

.btn-back {
    padding: 10px 20px;
    background: #e5e7eb;
    color: #333;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
}

.btn-back:hover {
    background: #d1d5db;
}

@media (max-width: 640px) {
    .shop-compare-container {
        padding: 8px;
    }

    .shop-grid {
        grid-template-columns: 1fr;
    }

    .price-section {
        grid-template-columns: 1fr;
    }
}
</style>