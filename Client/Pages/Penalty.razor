@page "/penalty"
@using AVANI.Client.Models
@inject AVANI.Client.Services.UserService UserService
@inject AVANI.Client.Services.CoinService CoinService
@inject NavigationManager Navigation

<div class="penalty-container">
    <h2>–ü—Ä–∏–º–µ–Ω–∏—Ç—å —à—Ç—Ä–∞—Ñ</h2>

    @if (!IsParent)
    {
        <div class="card warning-card">
            <p style="margin:0; color:#991b1b">
                ‚ö† –¢–æ–ª—å–∫–æ —Ä–æ–¥–∏—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å —à—Ç—Ä–∞—Ñ—ã.
                <button class="btn-link" @onclick="() => Navigation.NavigateTo('/login')">–í–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ –≤—Ö–æ–¥</button>
            </p>
        </div>
    }
    else
    {
        <div class="card form-card">
            <h4>–ù–∞–ª–æ–∂–∏—Ç—å —à—Ç—Ä–∞—Ñ –Ω–∞ —Ä–µ–±–µ–Ω–∫–∞</h4>

            <form @onsubmit="ApplyPenaltyAsync">
                <!-- Child ID Selection -->
                <div class="form-group">
                    <label for="childId">ID –†–µ–±–µ–Ω–∫–∞</label>
                    <input 
                        id="childId" 
                        type="text" 
                        @bind="ChildId" 
                        placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 1C –∏–ª–∏ 2C"
                        required 
                    />
                </div>

                <!-- Penalty Amount -->
                <div class="form-group">
                    <label for="amount">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç –¥–ª—è —à—Ç—Ä–∞—Ñ–∞</label>
                    <input 
                        id="amount" 
                        type="number" 
                        @bind="PenaltyAmount" 
                        min="1" 
                        max="1000"
                        placeholder="10"
                        required 
                    />
                    <span class="help-text">–ú–∏–Ω–∏–º—É–º: 1, –ú–∞–∫—Å–∏–º—É–º: 1000 –º–æ–Ω–µ—Ç</span>
                </div>

                <!-- Penalty Reason -->
                <div class="form-group">
                    <label for="reason">–ü—Ä–∏—á–∏–Ω–∞ —à—Ç—Ä–∞—Ñ–∞</label>
                    <textarea 
                        id="reason" 
                        @bind="PenaltyReason" 
                        placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –ù–µ –≤—ã–ø–æ–ª–Ω–∏–ª –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ, –ó–∞–±—ã–ª –ø—Ä–æ —Ü–µ–ª—å..."
                        maxlength="150"
                        rows="4"
                    />
                    <span class="char-count">@PenaltyReason.Length / 150</span>
                </div>

                <!-- Preset Reasons -->
                <div class="form-group">
                    <label>–ß–∞—Å—Ç—ã–µ –ø—Ä–∏—á–∏–Ω—ã</label>
                    <div class="preset-buttons">
                        <button type="button" class="preset-btn" @onclick="() => SelectPreset('–ù–µ –≤—ã–ø–æ–ª–Ω–∏–ª –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ')">
                            üìö –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ
                        </button>
                        <button type="button" class="preset-btn" @onclick="() => SelectPreset('–ù–µ–≤–µ–∂–ª–∏–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ')">
                            üò† –ù–µ–≤–µ–∂–ª–∏–≤–æ—Å—Ç—å
                        </button>
                        <button type="button" class="preset-btn" @onclick="() => SelectPreset('–ù–µ —É–±—Ä–∞–ª –∫–æ–º–Ω–∞—Ç—É')">
                            üè† –ë–µ—Å–ø–æ—Ä—è–¥–æ–∫
                        </button>
                        <button type="button" class="preset-btn" @onclick="() => SelectPreset('–ü–æ–∑–¥–Ω–æ –ª–µ–≥ —Å–ø–∞—Ç—å')">
                            üò¥ –†–µ–∂–∏–º –¥–Ω—è
                        </button>
                    </div>
                </div>

                <!-- Error & Success Messages -->
                @if (!string.IsNullOrEmpty(ErrorMessage))
                {
                    <div class="message error-message">
                        ‚ö† @ErrorMessage
                    </div>
                }

                @if (!string.IsNullOrEmpty(SuccessMessage))
                {
                    <div class="message success-message">
                        ‚úì @SuccessMessage
                    </div>
                }

                <!-- Action Buttons -->
                <div class="button-group">
                    <button type="submit" class="btn-primary" disabled="@(IsSubmitting || PenaltyAmount <= 0)">
                        @(IsSubmitting ? "–ü—Ä–∏–º–µ–Ω—è—é..." : "‚ö† –ü—Ä–∏–º–µ–Ω–∏—Ç—å —à—Ç—Ä–∞—Ñ")
                    </button>
                    <button type="button" class="btn-secondary" @onclick="GoBack">
                        ‚Üê –ù–∞–∑–∞–¥
                    </button>
                </div>
            </form>
        </div>

        <!-- Info Section -->
        <div class="card info-card">
            <h4>‚ö° –í–∞–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å</h4>
            <ul style="margin:0; padding-left:20px; color:#666; line-height:1.8">
                <li>–®—Ç—Ä–∞—Ñ—ã –ø–æ–º–æ–≥–∞—é—Ç —Ä–µ–±–µ–Ω–∫—É –Ω–∞—É—á–∏—Ç—å—Å—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏</li>
                <li>–ë—É–¥—å—Ç–µ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ã –∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã</li>
                <li>–û–±—ä—è—Å–Ω—è–π—Ç–µ –ø—Ä–∏—á–∏–Ω—É —à—Ç—Ä–∞—Ñ–∞</li>
                <li>–®—Ç—Ä–∞—Ñ—ã –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏—é –º–æ–Ω–µ—Ç</li>
                <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞–≥—Ä–∞–¥—ã –∏ –ø–æ–æ—â—Ä–µ–Ω–∏—è, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ —à—Ç—Ä–∞—Ñ—ã</li>
            </ul>
        </div>
    }
</div>

@code {
    private string ChildId = string.Empty;
    private int PenaltyAmount = 0;
    private string PenaltyReason = string.Empty;
    private string ErrorMessage = string.Empty;
    private string SuccessMessage = string.Empty;
    private bool IsParent = false;
    private bool IsSubmitting = false;

    protected override async Task OnInitializedAsync()
    {
        var user = await UserService.GetCurrentUser();
        IsParent = UserService.IsParent();

        if (!IsParent && user is not null)
        {
            // If child is logged in, auto-fill their ID (optional)
            // or redirect
        }
    }

    private async Task ApplyPenaltyAsync()
    {
        ErrorMessage = string.Empty;
        SuccessMessage = string.Empty;
        IsSubmitting = true;

        // Validate inputs
        if (string.IsNullOrWhiteSpace(ChildId))
        {
            ErrorMessage = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ ID —Ä–µ–±–µ–Ω–∫–∞.";
            IsSubmitting = false;
            return;
        }

        if (PenaltyAmount <= 0)
        {
            ErrorMessage = "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à—Ç—Ä–∞—Ñ–Ω—ã—Ö –º–æ–Ω–µ—Ç –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0.";
            IsSubmitting = false;
            return;
        }

        if (PenaltyAmount > 1000)
        {
            ErrorMessage = "–®—Ç—Ä–∞—Ñ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 1000 –º–æ–Ω–µ—Ç.";
            IsSubmitting = false;
            return;
        }

        if (string.IsNullOrWhiteSpace(PenaltyReason))
        {
            ErrorMessage = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É —à—Ç—Ä–∞—Ñ–∞.";
            IsSubmitting = false;
            return;
        }

        try
        {
            // Apply penalty via CoinService
            var success = await CoinService.PenalizeCoins(ChildId, PenaltyAmount, PenaltyReason);

            if (success)
            {
                SuccessMessage = $"‚úì –®—Ç—Ä–∞—Ñ –≤ {PenaltyAmount} –º–æ–Ω–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω —Ä–µ–±–µ–Ω–∫—É {ChildId}. –ü—Ä–∏—á–∏–Ω–∞: {PenaltyReason}";

                // Clear form
                ChildId = string.Empty;
                PenaltyAmount = 0;
                PenaltyReason = string.Empty;

                // Redirect after delay
                await Task.Delay(2000);
                Navigation.NavigateTo("/parent");
            }
            else
            {
                ErrorMessage = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ —à—Ç—Ä–∞—Ñ–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"–û—à–∏–±–∫–∞: {ex.Message}";
        }
        finally
        {
            IsSubmitting = false;
        }
    }

    private void SelectPreset(string reason)
    {
        PenaltyReason = reason;
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/parent");
    }
}

<style>
.penalty-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 16px;
}

.warning-card {
    background: #fee2e2;
    border-left: 4px solid #ef4444;
    padding: 16px;
    margin-bottom: 16px;
}

.btn-link {
    background: none;
    border: none;
    color: #2563eb;
    text-decoration: underline;
    cursor: pointer;
    font-weight: 600;
    padding: 0;
    margin-left: 4px;
}

.btn-link:hover {
    color: #1d4ed8;
}

.form-card {
    padding: 24px;
    margin-bottom: 16px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
    color: #333;
}

.form-group input,
.form-group textarea {
    width: 100%;
    padding: 10px;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    font-family: inherit;
    font-size: 1em;
    transition: border-color 0.2s;
}

.form-group input:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #ef4444;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
}

.help-text {
    display: block;
    font-size: 0.85em;
    color: #999;
    margin-top: 4px;
}

.char-count {
    display: block;
    font-size: 0.85em;
    color: #999;
    margin-top: 4px;
}

.preset-buttons {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
}

.preset-btn {
    padding: 10px;
    background: #f3f4f6;
    border: 2px solid #d1d5db;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.2s, border-color 0.2s;
}

.preset-btn:hover {
    background: #e5e7eb;
    border-color: #9ca3af;
}

.button-group {
    display: flex;
    gap: 8px;
    margin-top: 24px;
}

.btn-primary {
    flex: 1;
    padding: 12px 16px;
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 1em;
    cursor: pointer;
    transition: transform 0.2s;
}

.btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
}

.btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-secondary {
    flex: 1;
    padding: 12px 16px;
    background: #e5e7eb;
    color: #333;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
}

.btn-secondary:hover {
    background: #d1d5db;
}

.message {
    padding: 12px 16px;
    border-radius: 6px;
    margin-bottom: 12px;
    font-weight: 500;
}

.error-message {
    background: #fee2e2;
    border-left: 4px solid #ef4444;
    color: #991b1b;
}

.success-message {
    background: #dcfce7;
    border-left: 4px solid #10b981;
    color: #15803d;
}

.info-card {
    background: #fef3c7;
    border: 2px solid #fcd34d;
    padding: 16px;
}

.info-card h4 {
    margin-top: 0;
    color: #92400e;
}

@media (max-width: 640px) {
    .penalty-container {
        padding: 8px;
    }

    .form-card {
        padding: 16px;
    }

    .preset-buttons {
        grid-template-columns: 1fr;
    }

    .button-group {
        flex-direction: column;
    }
}
</style>